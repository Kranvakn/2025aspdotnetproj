@model todoApp.Models.TodoIndexVM
@{
    var todoList = Model.Items;
    var todoGroup = Model.Groups;
    var selectedGroupNo = Model.SelectedGroupNo;
    ViewBag.Title = "TODO APP";
}

<script>
    function showDeleteConfirm(title, message, todoId, groupNo, isDeleteGroup = false) {
        showMessageBox(title, message, () => {
            const form = document.getElementById("commonDeleteForm");
            const idInput = form.querySelector('input[name="Id"]');
            const groupInput = form.querySelector('input[name="SelectedGroupNo"]');

            // 공통으로 초기화
            idInput.value = "";
            groupInput.value = "";

            if (isDeleteGroup === true) {
                form.action = "/Todo/DeleteTodoGroup";
                groupInput.value = groupNo;
            } else {
                form.action = "/Todo/DeleteTodo";
                idInput.value = todoId;
                groupInput.value = groupNo;
            }

            form.submit();
        });
    }
</script>

<link rel="stylesheet" href="~/css/messageBox.css" />
<link rel="stylesheet" href="~/css/index.css" />
<h2>タスク管理</h2>
<p>タスクを追加して管理しましょう。</p>
<hr>
<div class="d-flex" style="gap: 20px; align-items: flex-start;">
    <div class="leftPannel">
        <h3 class="mb-3">タスクグループ</h3>
        <form method="post" asp-controller="Todo" asp-action="CreateGroup">
            <div style="display: flex; gap: 10px;">
                <input type="text" class="form-control mb-3" placeholder="タスクテーマを入力してください。"
                    style="flex: 1 1 0; height: 50px; border-radius: 0.375rem; border: 1px solid #ced4da; padding: 0 10px; font-size: 1rem; margin-bottom: 0;"
                    name="todoGroup" />
                <button class="btn btn-success" type="submit" style="height: 50px;">追加</button>
            </div>
        </form>

        @if (todoGroup == null || !todoGroup.Any())
        {
            <tr>
                <td colspan="4" class="text-center">タスクグループがありません。</td>
            </tr>
        }
        else
        {
            <div style="max-height: 500px; overflow-y: auto;">
                <ul class="list-group shadow-sm rounded" style="background: #fff; border: 1px solid #e9ecef;">
                    @foreach (var grp in todoGroup)
                    {
                        <li class="list-group-item todo-group-item d-flex justify-content-between align-items-center">

                            <a asp-controller="Todo" asp-action="GetTodoListByGroupNo" asp-route-id="@grp.GroupNo"
                                class="todo-link flex-grow-1"
                                style="background:none;border:none;padding:0;text-align:left; text-decoration:none;">
                                @grp.Title
                            </a>

                            <!-- 삭제 버튼 -->
                            <button onclick="showDeleteConfirm('グループ削除', '該当グループを削除しますか？', -1, @grp.GroupNo, true)"
                                class="btn btn-sm theme-delete-btn" type="button" title="削除">
                                <svg width="18" height="18" fill="none" viewBox="0 0 15 15">
                                    <path
                                        d="M11.78 4.03c.23-.23.23-.59 0-.81a.57.57 0 0 0-.81 0L7.5 6.69 4.03 3.22a.57.57 0 0 0-.81 0c-.23.22-.23.58 0 .81L6.69 7.5l-3.47 3.47c-.23.23-.23.59 0 .81.22.23.58.23.81 0l3.47-3.47 3.47 3.47c.23.23.59.23.81 0 .23-.22.23-.58 0-.81L8.31 7.5l3.47-3.47z"
                                        fill="#888" />
                                </svg>
                            </button>
                        </li>
                    }
                </ul>
            </div>
        }
    </div>
    <div class="rightPannel">
@* 일괄삭제 *@
        <div class="d-flex align-items-center justify-content-between mb-3" style="gap: 10px;">
            <h2 style="margin: 0;">ダスクリスト</h2>
            <div>
                <button class="btn btn-danger d-flex align-items-center" type="button"
                    onclick="showDeleteConfirm('全て削除', '完了したタスクを全て削除しますか？', -1, @selectedGroupNo, false)"
                    style="gap: 6px; font-size: 1rem; padding: 6px 14px;" disabled="@((selectedGroupNo == null) ? "disabled" : null)">
                    <svg width="20" height="20" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M11.7816 4.03157C12.0062 3.80702 12.0062 3.44295 11.7816 3.2184C11.5571 2.99385 11.193 2.99385 10.9685 3.2184L7.50005 6.68682L4.03164 3.2184C3.80708 2.99385 3.44301 2.99385 3.21846 3.2184C2.99391 3.44295 2.99391 3.80702 3.21846 4.03157L6.68688 7.49999L3.21846 10.9684C2.99391 11.193 2.99391 11.557 3.21846 11.7816C3.44301 12.0061 3.80708 12.0061 4.03164 11.7816L7.50005 8.31316L10.9685 11.7816C11.193 12.0061 11.5571 12.0061 11.7816 11.7816C12.0062 11.557 12.0062 11.193 11.7816 10.9684L8.31322 7.49999L11.7816 4.03157Z"
                            fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path>
                    </svg>
                    <span style="font-size: 1.1rem; font-weight: 500;">完了項目一括削除</span>
                </button>
            </div>
        </div>
@* 생성 *@
        <form method="post" asp-controller="Todo" asp-action="Create">
            <div class="input-group mb-3">
                @if (ViewBag.Error != null)
                {
                    <p style="color: red">@ViewBag.Error</p>
                }
                <input type="hidden" name="groupNo" value="@selectedGroupNo" />
                <input type="text" class="form-control" name="todoText" placeholder="タスクを入力してください。" disabled="@((selectedGroupNo == null) ? "disabled" : null)" required />
                <button class="btn btn-primary" type="submit" disabled="@((selectedGroupNo == null) ? "disabled" : null)">追加</button>
            </div>
        </form>
        <table class="table">
            <thead>
                <tr>
                    @* <th style="width:5%">
                            <input type="checkbox" style="width:20px; height:20px;" onclick="onClickCheckbox()" />
                        </th> *@
                    <th style="width:40%">リスト</th>
                    <th style="width:10%">状態</th>
                    <th style="width:20%">更新</th>
                    <th style="width:20%">追加</th>
                </tr>
            </thead>
        </table>
        <div style="max-height: 500px; overflow-y: auto;">
            <table class="table">
                <tbody>
                    @if (selectedGroupNo == null)
                    {
                        <tr>
                            <td colspan="4" class="text-center"><h1>タスクグループを選択してください。</h1></td>
                        </tr>
                    }
                    else if (selectedGroupNo != null && (todoList == null || !todoList.Any()))
                    {
                        <tr>
                            <td colspan="4" class="text-center"><h1>タスクがありません。</h1><h4>やるべきことを作成してみましょう。</h4></td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var todo in todoList)
                        {
                            <tr @if (todo.IsDone) {
                            <text>class="table-success"</text>
                            }
                                                else
                            {
                                <text>class="table-light"</text>
                            }
                            >
                            @* <td>
                    <input type="checkbox" style="width:20px; height:20px;" onclick="onClickCheckbox()" />
                </td> *@
                            @if (todo.IsDone)
                            {
                                <td style="width:30%">
                                    <div class="text-decoration-line-through">@todo.Content</div>
                                    <b>完了：@todo.DoneDate</b>
                                </td>
                                <td class="text-decoration-line-through" style="width:7%">
                                    <svg width="30" height="30" viewBox="0 0 15 15" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path
                                            d="M11.4669 3.72684C11.7558 3.91574 11.8369 4.30308 11.648 4.59198L7.39799 11.092C7.29783 11.2452 7.13556 11.3467 6.95402 11.3699C6.77247 11.3931 6.58989 11.3355 6.45446 11.2124L3.70446 8.71241C3.44905 8.48022 3.43023 8.08494 3.66242 7.82953C3.89461 7.57412 4.28989 7.55529 4.5453 7.78749L6.75292 9.79441L10.6018 3.90792C10.7907 3.61902 11.178 3.53795 11.4669 3.72684Z"
                                            fill="green" fill-rule="evenodd" clip-rule="evenodd"></path>
                                    </svg>
                                </td>
                            }
                            else
                            {
                                <td style="width:30%">@todo.Content</td>
                                <td style="width:7%">
                                    <svg width="30" height="30" viewBox="0 0 15 15" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path
                                            d="M2.14645 11.1464C1.95118 11.3417 1.95118 11.6583 2.14645 11.8536C2.34171 12.0488 2.65829 12.0488 2.85355 11.8536L6.85355 7.85355C7.04882 7.65829 7.04882 7.34171 6.85355 7.14645L2.85355 3.14645C2.65829 2.95118 2.34171 2.95118 2.14645 3.14645C1.95118 3.34171 1.95118 3.65829 2.14645 3.85355L5.79289 7.5L2.14645 11.1464ZM8.14645 11.1464C7.95118 11.3417 7.95118 11.6583 8.14645 11.8536C8.34171 12.0488 8.65829 12.0488 8.85355 11.8536L12.8536 7.85355C13.0488 7.65829 13.0488 7.34171 12.8536 7.14645L8.85355 3.14645C8.65829 2.95118 8.34171 2.95118 8.14645 3.14645C7.95118 3.34171 7.95118 3.65829 8.14645 3.85355L11.7929 7.5L8.14645 11.1464Z"
                                            fill="gray" fill-rule="evenodd" clip-rule="evenodd"></path>
                                    </svg>
                                </td>
                            }
                            <td style="width:15%">
                                <div class="d-flex gap-2">
                                    <form method="post" asp-controller="Todo" asp-action="Done" class="m-0">
                                        <input type="hidden" name="Id" value="@todo.Id" />
                                        <input type="hidden" name="Content" value="@todo.Content" />
                                        <input type="hidden" name="IsDone" value="@todo.IsDone" />
                                        <input type="hidden" name="selectedGroupNo" value="@selectedGroupNo" />
                                        <button class="btn btn-success" type="submit">
                                            <svg width="20" height="20" viewBox="0 0 15 15" fill="none"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path
                                                    d="M11.4669 3.72684C11.7558 3.91574 11.8369 4.30308 11.648 4.59198L7.39799 11.092C7.29783 11.2452 7.13556 11.3467 6.95402 11.3699C6.77247 11.3931 6.58989 11.3355 6.45446 11.2124L3.70446 8.71241C3.44905 8.48022 3.43023 8.08494 3.66242 7.82953C3.89461 7.57412 4.28989 7.55529 4.5453 7.78749L6.75292 9.79441L10.6018 3.90792C10.7907 3.61902 11.178 3.53795 11.4669 3.72684Z"
                                                    fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path>
                                            </svg>
                                        </button>
                                    </form>
                                    <button class="btn btn-danger" type="submit"
                                        onclick="showDeleteConfirm('削除確認', '本当にこのタスクを削除しますか？', @todo.Id, @selectedGroupNo, false)">
                                        <svg width="20" height="20" viewBox="0 0 15 15" fill="none"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <path
                                                d="M11.7816 4.03157C12.0062 3.80702 12.0062 3.44295 11.7816 3.2184C11.5571 2.99385 11.193 2.99385 10.9685 3.2184L7.50005 6.68682L4.03164 3.2184C3.80708 2.99385 3.44301 2.99385 3.21846 3.2184C2.99391 3.44295 2.99391 3.80702 3.21846 4.03157L6.68688 7.49999L3.21846 10.9684C2.99391 11.193 2.99391 11.557 3.21846 11.7816C3.44301 12.0061 3.80708 12.0061 4.03164 11.7816L7.50005 8.31316L10.9685 11.7816C11.193 12.0061 11.5571 12.0061 11.7816 11.7816C12.0062 11.557 12.0062 11.193 11.7816 10.9684L8.31322 7.49999L11.7816 4.03157Z"
                                                fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                            <td style="width:15%">
                                @todo.AddDate</td>
                        </tr>
                    }
                                        }
                    <script src="@(Url.Content("~/js/messageBox.js"))"></script>
                </tbody>
            </table>
        </div>

        <form id="commonDeleteForm" method="post" style="display:none;">
            <input type="hidden" name="Id" value="" />
            <input type="hidden" name="SelectedGroupNo" value="" />
        </form>